<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Late Night Intrusive Thoughts</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Volkhov:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    /* =====================================
       DESIGN TOKENS & RESET
       ===================================== */
    :root {
      --bg: #ffffff;
      --text: #111111;
      --icon: #000000;
      --sidebar-bg: #f2f2f2;
      --content-fs: 18px;   /* solo cuerpo del artÃ­culo */
    }
    .dark{
      --bg:#121212;
      --text:#e4e4e4;
      --icon:#ffffff;
      --sidebar-bg:#1e1e1e;
    }

    *{margin:0;padding:0;box-sizing:border-box;}

    body{
      background:var(--bg);
      color:var(--text);
      font-family:"Volkhov",serif;
      line-height:1.6;
      min-height:100vh;
      overflow-x:hidden;
    }

    a{color:var(--icon);text-decoration:none;}

    .menu-font{font-family:"Inter",sans-serif;}

    /* ---------- TOP BAR ---------- */
    header.topbar{
      display:flex;align-items:center;gap:1rem;
      padding:.75rem 1rem;
    }
    .icon-btn{
      background:none;border:none;cursor:pointer;font:inherit;
      padding:.25rem .5rem;position:relative;color:var(--icon);
    }
    .icon-btn::after{
      content:'';position:absolute;inset:0;border-radius:4px;
      background:var(--icon);opacity:0;transition:opacity .15s;
    }
    .icon-btn:hover::after{opacity:.12;}
    .ux-controls{margin-left:auto;display:flex;gap:.35rem;}

    /* ---------- SIDEBAR ---------- */
    .sidebar{
      position:fixed;inset:0 auto 0 0;
      width:260px;max-width:80%;
      background:var(--sidebar-bg);
      transform:translateX(-100%);
      transition:transform .3s ease;
      padding:1rem;z-index:999;overflow-y:auto;
    }
    .sidebar.open{transform:translateX(0);}
    .sidebar h2{font-size:1.1rem;margin-bottom:1rem;color:var(--icon);}
    .sidebar ul{list-style:none;}
    .sidebar li{margin:.25rem 0;}
    .sidebar a{display:block;padding:.35rem .5rem;border-radius:4px;transition:background .15s;color:var(--icon);}
    .sidebar a:hover{background:rgba(0,0,0,.08);}
    .dark .sidebar a:hover{background:rgba(255,255,255,.12);}
    .sidebar a.active{text-decoration:underline;text-underline-offset:2px;}
    .close-btn{position:absolute;top:.5rem;right:.5rem;font-size:1.5rem;color:var(--icon);}

    /* ---------- MAIN ---------- */
    main{max-width:800px;margin:0 auto;padding:2rem 1rem;font-size:var(--content-fs);}
    main h2{margin-bottom:.75rem;font-weight:700;}
    main p{margin-bottom:1rem;text-align:justify;}
    .fly{display:inline-block;pointer-events:none;}
  </style>
</head>
<body>
  <!-- TOP BAR -->
  <header class="topbar menu-font">
    <button id="menuToggle" class="icon-btn" aria-label="Open menu">â˜°</button>

    <div class="ux-controls">
      <!-- letter-soup placeholder -->
      <button id="cloakToggle" class="icon-btn menu-font" aria-label="Letter soup">ðŸ¥„</button>

      <button id="fontSmaller" class="icon-btn menu-font" aria-label="Smaller text">A-</button>
      <button id="fontBigger"  class="icon-btn menu-font" aria-label="Bigger text">A+</button>

      <button id="themeToggle" class="icon-btn menu-font" aria-label="Toggle theme">â˜¾</button>
      <button id="langToggle"  class="icon-btn menu-font" aria-label="Toggle language">EN</button>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside id="sidebar" class="sidebar" aria-hidden="true">
    <button id="closeSidebar" class="icon-btn close-btn" aria-label="Close menu">Ã—</button>
    <h2 class="menu-font" data-i18n="menuTitle">Late night intrusive thoughts</h2>
    <nav>
      <ul id="chapterList">
        <li><a href="#" data-id="chapter-1" class="menu-font active" data-i18n="chapter1">Chapter 1</a></li>
        <li><a href="#" data-id="chapter-2" class="menu-font" data-i18n="chapter2">Chapter 2</a></li>
      </ul>
    </nav>
  </aside>

  <!-- CONTENT -->
  <main id="content">
    <article id="chapter-1">
      <h2>Heading 1</h2>
      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla vel luctus erat. Proin fermentum dui vel orci placerat...</p>
      <p>Integer euismod lacus sit amet aliquam mattis...</p>
    </article>

    <article id="chapter-2" hidden>
      <h2>Heading 2</h2>
      <p>Duis bibendum nisl at mi scelerisque, eget sodales nisl interdum...</p>
      <p>Praesent non sapien sed nisi imperdiet tempor...</p>
    </article>
  </main>

  <!-- SCRIPT -->
  <script>
    /* ---------- SIDEBAR ---------- */
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menuToggle');
    const closeSidebar = document.getElementById('closeSidebar');
    const openMenu = () => { sidebar.classList.add('open'); sidebar.setAttribute('aria-hidden','false'); };
    const closeMenu= () => { sidebar.classList.remove('open'); sidebar.setAttribute('aria-hidden','true'); };
    menuToggle.addEventListener('click',openMenu);
    closeSidebar.addEventListener('click',closeMenu);

    /* ---------- CHAPTER SWITCH ---------- */
    const chapterLinks=[...document.querySelectorAll('#chapterList a')];
    const articles=[...document.querySelectorAll('main article')];
    chapterLinks.forEach(link=>{
      link.addEventListener('click',e=>{
        e.preventDefault();
        const id=link.dataset.id;
        articles.forEach(a=>a.hidden=a.id!==id);
        chapterLinks.forEach(l=>l.classList.toggle('active',l===link));
        closeMenu();
      });
    });

    /* ---------- FONT SIZE ---------- */
    const fontSmaller=document.getElementById('fontSmaller');
    const fontBigger=document.getElementById('fontBigger');
    const MIN=14,MAX=24,STEP=2;
    function updateFont(delta){
      const root=document.documentElement;
      const current=parseInt(getComputedStyle(root).getPropertyValue('--content-fs'));
      const next=Math.min(MAX,Math.max(MIN,current+delta));
      root.style.setProperty('--content-fs',next+'px');
      localStorage.setItem('contentFS',next);
    }
    fontSmaller.addEventListener('click',()=>updateFont(-STEP));
    fontBigger.addEventListener('click',()=>updateFont(STEP));
    const savedFS=+localStorage.getItem('contentFS');
    if(savedFS) document.documentElement.style.setProperty('--content-fs',savedFS+'px');

    /* ---------- THEME ---------- */
    const themeToggle=document.getElementById('themeToggle');
    const MOON='â˜¾', SUN='â˜€';
    if(localStorage.getItem('prefDark')==='true'){
      document.body.classList.add('dark');
      themeToggle.textContent=SUN;
    }
    themeToggle.addEventListener('click',()=>{
      const dark=document.body.classList.toggle('dark');
      localStorage.setItem('prefDark',dark);
      themeToggle.textContent=dark?SUN:MOON;
    });

/* ---------- LETTER-SOUP EFFECT v3 (rebote continuo) ---------- */
const cloakToggle = document.getElementById('cloakToggle');
let cloaked = false, clones = [], rafId = null;

const SPEED = 90;           // px por segundo (ajusta a tu gusto)

cloakToggle.addEventListener('click', () => {
  cloaked ? restore() : explode();
  cloaked = !cloaked;
});

/* crea spans, les da velocidad y arranca el loop ------------- */
function explode() {
  const article = document.querySelector('main article:not([hidden])');
  if (!article) return;

  if (!article.dataset.origHTML) article.dataset.origHTML = article.innerHTML;

  // 1. envuelve letras (igual que antes)
  article.innerHTML = Array.from(article.innerText).map(ch => {
    if (ch === '\n') return '<br>';
    if (/\s/.test(ch)) return ch;
    return `<span class="fly">${ch}</span>`;
  }).join('');

  const spans = [...article.querySelectorAll('span.fly')];
  const rects = spans.map(s => s.getBoundingClientRect()); // 2. medir con el artÃ­culo visible

  article.style.visibility = 'hidden';                     // 3. ahora sÃ­ lo ocultamos

  clones = spans.map((s, i) => {
    const {left:x, top:y, width:w, height:h} = rects[i];
    const node = s.cloneNode(true);
    Object.assign(node.style,{
      position:'fixed',left:`${x}px`,top:`${y}px`,
      font:'inherit',color:'inherit'
    });
    document.body.appendChild(node);
    const a = Math.random()*Math.PI*2;
    return {node, x, y, w, h, vx:Math.cos(a)*SPEED, vy:Math.sin(a)*SPEED, ox:x, oy:y};
  });

  runLoop(performance.now());
}

function restore(){
  if (!clones.length) return;                              // evita TypeError

  cancelAnimationFrame(rafId);
  clones.forEach(c=>{
    c.node.style.transition='transform .5s ease';
    c.node.style.transform='translate(0,0)';
  });

  clones[0].node.addEventListener('transitionend', () => {
    clones.forEach(c=>c.node.remove());
    clones = [];
    const article = document.querySelector('main article:not([hidden])');
    if (article){
      article.style.visibility = '';
      article.innerHTML = article.dataset.origHTML;
    }
  }, {once:true});
}


/* animaciÃ³n frame-a-frame con rebote ------------------------- */
function runLoop(prev) {
  rafId = requestAnimationFrame(now => {
    const dt = (now - prev)/1000;          // segundos desde el frame anterior
    const vw = innerWidth, vh = innerHeight;

    clones.forEach(c => {
      c.x += c.vx * dt;
      c.y += c.vy * dt;

      // rebote en bordes
      if (c.x <= 0 || c.x + c.w >= vw){ c.vx *= -1; c.x = Math.max(0, Math.min(c.x, vw-c.w)); }
      if (c.y <= 0 || c.y + c.h >= vh){ c.vy *= -1; c.y = Math.max(0, Math.min(c.y, vh-c.h)); }

      c.node.style.transform = `translate(${c.x-c.ox}px, ${c.y-c.oy}px)`;
    });

    runLoop(now);
  });
}

/* vuelve a la posiciÃ³n original y limpia --------------------- */
function restore(){
  cancelAnimationFrame(rafId);
  clones.forEach(c=>{
    c.node.style.transition='transform .5s ease';
    c.node.style.transform='translate(0,0)';
  });

  // cuando el primer clon termina la transiciÃ³n, limpiamos
  clones[0].node.addEventListener('transitionend', () => {
    clones.forEach(c=>c.node.remove());
    clones = [];
    const article = document.querySelector('main article:not([hidden])');
    if(article){
      article.style.visibility='';
      article.innerHTML = article.dataset.origHTML;
    }
  }, {once:true});
}

    /* ---------- LANGUAGE (UI labels) ---------- */
    const langToggle=document.getElementById('langToggle');
    const strings={
      en:{menuTitle:'Late night intrusive thoughts',chapter1:'Chapter 1',chapter2:'Chapter 2',LANG:'EN'},
      es:{menuTitle:'Pensamientos intrusivos de madrugada',chapter1:'CapÃ­tulo 1',chapter2:'CapÃ­tulo 2',LANG:'ES'}
    };
    let lang=localStorage.getItem('lang')||'en';
    function translate(){
      const dict=strings[lang];
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const k=el.dataset.i18n;
        if(dict[k]) el.textContent=dict[k];
      });
      langToggle.textContent=dict.LANG;
    }
    langToggle.addEventListener('click',()=>{
      lang=lang==='en'?'es':'en';
      localStorage.setItem('lang',lang);
      translate();
    });
    translate();
  </script>
</body>
</html>